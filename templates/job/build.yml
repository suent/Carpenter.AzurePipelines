#    Carpenter.AzurePipelines
#
#    Common YAML templates and scripts for Azure Pipelines definitions.
#
#
#    Copyright © 2015-2022 Suent Networks, All rights reserved.
#
#    Permission is hereby granted, free of charge, to any person obtaining a copy
#    of this software and associated documentation files (the "Software"), to deal
#    in the Software without restriction, including without limitation the rights
#    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
#    copies of the Software, and to permit persons to whom the Software is
#    furnished to do so, subject to the following conditions:
#
#    The above copyright notice and this permission notice shall be included in all
#    copies or substantial portions of the Software.
#
#    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
#    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
#    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
#    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
#    SOFTWARE.

# SPDX-License-Identifier: MIT


parameters:

  # See docs/parameters.md for parameter documentation.

- name: pipelineVersion
  type: number

- name: includePipeline
  type: boolean

- name: buildPurpose
  type: string

- name: project
  type: string

- name: defaultPoolType
  type: string

- name: defaultPoolName
  type: string

- name: defaultPoolDemands
  type: object

- name: defaultPoolVMImage
  type: string
    
- name: versionType
  type: string

- name: versionFile
  type: string

- name: revisionOffset
  type: string

- name: prereleaseLabel
  type: string

- name: incrementVersionOnRelease
  type: boolean

- name: buildDotNet
  type: boolean

- name: executeUnitTests
  type: boolean

- name: sonarCloud
  type: boolean

- name: sonarCloudOrganization
  type: string

- name: sonarCloudProjectKey
  type: string

- name: sonarCloudServiceConnection
  type: string

- name: deployBranch
  type: string

- name: deployNuGet
  type: string

- name: nuGetTargetFeedDev
  type: string

- name: nuGetTargetFeedTest1
  type: string

- name: nuGetTargetFeedTest2
  type: string

- name: nuGetTargetFeedStable
  type: string

- name: nuGetTargetFeedProdUS
  type: string


jobs:
- job: build
  displayName: Build


  pool:
    ${{ if eq(parameters.defaultPoolType,'Hosted') }}:
      vmImage: ${{ parameters.defaultPoolVMImage }}
    ${{ if eq(parameters.defaultPoolType,'Private') }}:
      name: ${{ parameters.defaultPoolName }}
      ${{ if gt(length(parameters.defaultPoolDemands),0) }}:
        demands: ${{ parameters.defaultPoolDemands }}


  workspace:
    clean: all


  variables:
  - name: Carpenter.PipelineVersion
    value: ${{ parameters.pipelineVersion }}

  - ${{ if eq(parameters.includePipeline,'true') }}:
    - name: Carpenter.Pipeline
      value: true
    - name: Carpenter.Pipeline.Path
      value: $[ format('{0}/{1}/{2}', '$(Agent.BuildDirectory)', 's', 'Carpenter.AzurePipelines') ]
    - name: Carpenter.Project.Path
      value: $[ format('{0}/{1}/{2}', '$(Agent.BuildDirectory)', 's', variables['Build.DefinitionName']) ]
  - ${{ if ne(parameters.includePipeline,'true') }}:
    - name: Carpenter.Pipeline
      value: false
    - name: Carpenter.Pipeline.Path
      value: $[ format('{0}/{1}', '$(Agent.BuildDirectory)', 's') ]
    - name: Carpenter.Project.Path
      value: $[ format('{0}/{1}', '$(Agent.BuildDirectory)', 's') ]

  - name: Carpenter.Pipeline.ScriptPath
    value: $[ format('{0}/{1}', variables['Carpenter.Pipeline.Path'], 'scripts') ]

  - name: Carpenter.DotNet.Path
    value: $[ format('{0}/{1}', '$(Agent.ToolsDirectory)', 'dotnet')]

  - name: Carpenter.Solution.Path
    value: $[ format('{0}/{1}.sln', '$(Carpenter.Project.Path)', '$(Carpenter.Project)') ]

  - name: Carpenter.Output.Path
    value: $[ format('{0}/{1}', '$(System.DefaultWorkingDirectory)', 'out') ]

  - name: Carpenter.Output.Binaries.Path
    value: $[ format('{0}/{1}', '$(Carpenter.Output.Path)', 'bin') ]

  - name: Carpenter.Output.Tests.Path
    value: $[ format('{0}/{1}', '$(Carpenter.Output.Path)', 'tests') ]

  - name: Carpenter.Output.TestCoverage.Path
    value: $[ format('{0}/{1}', '$(Carpenter.Output.Path)', 'testCoverage') ]

  - name: Carpenter.Output.NuGet.Path
    value: $[ format('{0}/{1}', '$(Carpenter.Output.Path)', 'nuget') ]

  - ${{ if eq(variables['Build.Reason'],'Manual') }}:
    - name: Carpenter.Build.Purpose
      value: ${{ parameters.buildPurpose }}

  - name: Carpenter.Project
    value: ${{ parameters.project }}

  - name: Carpenter.Pool.Default.Type
    value: ${{ parameters.defaultPoolType }}

  - ${{ if eq(parameters.defaultPoolType,'Hosted') }}:
    - name: Carpenter.Pool.Default.VMImage
      value: ${{ parameters.defaultPoolVMImage}}

  - ${{ if eq(parameters.defaultPoolType,'Private') }}:
    - name: Carpenter.Pool.Default.Name
      value: ${{ parameters.defaultPoolName }}
  
    - ${{ if eq(length(parameters.defaultPoolDemands),0) }}:
      - name: Carpenter.Pool.Default.Demands
        value: False
  
    - ${{ if gt(length(parameters.defaultPoolDemands),0) }}:
      - name: Carpenter.Pool.Default.Demands
        value: True

  - name: Carpenter.Version.Type
    value: ${{ parameters.versionType }}
  
  - ${{ if ne(parameters.versionType,'None') }}:

    - name: Carpenter.Version.VersionFile
      value: ${{ parameters.versionFile }}

    - name: Carpenter.Version.RevisionOffset
      value: ${{ parameters.revisionOffset }}

    - ${{ if or(eq(variables['Build.Reason'],'IndividualCI'), eq(variables['Build.Reason'],'BatchedCI'), and(eq(variables['Build.Reason'],'Manual'), eq(parameters['buildPurpose'],'CI'))) }}:
      - name: Carpenter.ContinuousIntegration.Date
        value: $[ format('{0:yyyyMMdd}', pipeline.startTime) ]

    - ${{ if eq(parameters['buildPurpose'],'Prerelease')}}:
      - name: Carpenter.Prerelease.Label
        value: ${{ parameters.prereleaseLabel }}

    - ${{ if eq(parameters['buildPurpose'],'Release')}}:
      - name: Carpenter.Version.IncrementOnRelease
        value: ${{ parameters.incrementVersionOnRelease }}

  - name: Carpenter.Build.DotNet
    value: ${{ parameters.buildDotNet }}

  - name: Carpenter.Test.Unit
    value: ${{ parameters.executeUnitTests }}

  - name: Carpenter.SonarCloud
    value: ${{ parameters.sonarCloud }}

  - ${{ if eq(parameters.sonarCloud, 'true') }}:
    - name: Carpenter.SonarCloud.Organization
      value: ${{ parameters.sonarCloudOrganization }}

    - name: Carpenter.SonarCloud.ProjectKey
      value: ${{ parameters.sonarCloudProjectKey }}
     
    - name: Carpenter.SonarCloud.ServiceConnection
      value: ${{ parameters.sonarCloudServiceConnection }}

  - name: Carpenter.Deploy.Branch
    value: ${{ parameters.deployBranch }}

  - name: Carpenter.Deploy.NuGet
    value: ${{ parameters.deployNuGet }}

  - ${{ if contains(parameters.deployNuGet,'dev') }}:
    - name: Carpenter.Deploy.NuGet.TargetFeed.Dev
      value: ${{ parameters.nuGetTargetFeedDev }}

  - ${{ if contains(parameters.deployNuGet,'test1') }}:
    - name: Carpenter.Deploy.NuGet.TargetFeed.Test1
      value: ${{ parameters.nuGetTargetFeedTest1 }}

  - ${{ if contains(parameters.deployNuGet,'test2') }}:
    - name: Carpenter.Deploy.NuGet.TargetFeed.Test2
      value: ${{ parameters.nuGetTargetFeedTest2 }}

  - ${{ if contains(parameters.deployNuGet,'stable') }}:
    - name: Carpenter.Deploy.NuGet.TargetFeed.Stable
      value: ${{ parameters.nuGetTargetFeedStable }}

  - ${{ if contains(parameters.deployNuGet,'prod_us') }}:
    - name: Carpenter.Deploy.NuGet.TargetFeed.ProdUS
      value: ${{ parameters.nuGetTargetFeedProdUS }}


  steps:
  - checkout: self
  
  # Publish source artifact
  - publish: $(System.DefaultWorkingDirectory)
    artifact: source
    displayName: 'Publish artifact: source'

  # Include pipeline for access to pipeline scripts
  - ${{ if eq(parameters.includePipeline, 'true') }}:
    - checkout: Carpenter
      persistCredentials: true

  - template: ../step/display-environment.yml

  - task: PowerShell@2
    inputs:
      targetType: 'filePath'
      filePath: $(Carpenter.Pipeline.ScriptPath)/ValidatePipeline.ps1
      arguments: -Verbose
    displayName: Validate pipeline

  - task: PowerShell@2
    inputs:
      targetType: 'filePath'
      filePath: $(Carpenter.Pipeline.ScriptPath)/InitializePipeline.ps1
      arguments: -Verbose
    displayName: Initialize pipeline
    name: initializePipeline

  - ${{ if ne(parameters.versionType,'None') }}:
    - task: PowerShell@2
      inputs:
        targetType: 'filePath'
        filePath: $(Carpenter.Pipeline.ScriptPath)/InitializeBuildVersion.ps1
        arguments: -Verbose
      displayName: Initialize versioning
      name: initializeBuildVersion

  - ${{ if eq(parameters.buildDotNet, 'true') }}:

    - task: UseDotNet@2
      displayName: 'Use .NET Core'
      condition: succeeded()
      inputs:
        packageType: sdk
        version: 6.x
        installationPath: $(Carpenter.DotNet.Path)

    - ${{ if eq(parameters.sonarCloud, 'true') }}:
      - task: SonarSource.sonarcloud.14d9cde6-c1da-4d55-aa01-2965cd301255.SonarCloudPrepare@1
        displayName: 'Prepare analysis: SonarCloud'
        condition: succeeded()
        inputs:
          SonarCloud: ${{ parameters.sonarCloudServiceConnection }}
          organization: $(Carpenter.SonarCloud.Organization)
          projectKey: $(Carpenter.SonarCloud.ProjectKey)
          projectVersion: '$(Build.BuildNumber)'
          extraProperties: |
            sonar.cs.opencover.reportsPaths=$(Carpenter.Output.Tests.Path)/coverage.opencover.xml
            sonar.test.exclusions=**/coverage.*.xml
            sonar.cs.vstest.reportsPaths=$(Carpenter.Output.Tests.Path)/*.trx

    - task: DotNetCoreCLI@2
      displayName: 'Build: dotnet'
      condition: succeeded()
      inputs:
        command: build
        projects: '$(Carpenter.Solution.Path)'
        arguments: '--output $(Carpenter.Output.Binaries.Path) --configuration Debug --version-suffix "$(Carpenter.Version.Label)" /p:VersionPrefix=$(Carpenter.Version.BaseVersion) /p:Version=$(Carpenter.Version) /p:AssemblyVersion=$(Carpenter.Version.Major).0.0.0 /p:FileVersion=$(Carpenter.Version.BaseVersion).$(Carpenter.Version.Revision) /p:InformationalVersion=$(Carpenter.Version) /p:PackageVersion=$(Carpenter.Version) /p:GeneratePackageOnBuild=true'

    - task: CopyFiles@2
      displayName: 'Copy files: NuGet.Config'
      condition: succeeded()
      inputs:
        cleanTargetFolder: true
        sourceFolder: $(Carpenter.Project.Path)
        contents: 'NuGet.Config'
        targetFolder: $(Carpenter.Output.NuGet.Path)

    - task: CopyFiles@2
      displayName: 'Copy files: nupkg'
      condition: succeeded()
      inputs:
        cleanTargetFolder: true
        sourceFolder: $(Carpenter.Output.Binaries.Path)
        contents: '*.nupkg'
        targetFolder: $(Carpenter.Output.NuGet.Path)

    - task: DeleteFiles@1
      displayName: 'Remove files: nupkg'
      condition: succeeded()
      inputs:
        sourceFolder: $(Carpenter.Output.Binaries.Path)
        contents: '*.nupkg'

    - publish: '$(Carpenter.Output.Binaries.Path)'
      displayName: 'Publish artifact: binaries'
      artifact: binaries
      condition: succeeded()

    - publish: '$(Carpenter.Output.NuGet.Path)'
      displayName: 'Publish artifact: nuget'
      artifact: package.nuget
      condition: succeeded()

    - ${{ if eq(parameters.sonarCloud, 'true') }}:
      - task: DotNetCoreCLI@2
        displayName: 'Test: L0 unit tests'
        condition: succeeded()
        inputs:
          command: test
          projects: '$(Carpenter.Solution.Path)'
          arguments: '--output $(Carpenter.Output.Binaries.Path) --filter Category=UnitTest --logger trx --results-directory $(Carpenter.Output.Tests.Path) --configuration Debug /p:CollectCoverage=true /p:CoverletOutput=$(Carpenter.Output.Tests.Path)/ /p:CoverletOutputFormat="cobertura%2copencover"'
          publishTestResults: false # manually publish later, we want trx results saved to specific location
          nobuild: true

      - task: PublishTestResults@2
        displayName: 'Publish results: L0'
        condition: succeeded()
        inputs:
          testResultsFormat: 'VSTest'
          testResultsFiles: $(Carpenter.Output.Tests.Path)/*.trx
          testRunTitle: '$(Carpenter.Project) L0 - Unit Tests'
          buildConfiguration: Debug
          buildPlatform: Any CPU
          publishRunAttachments: true
    
      - script: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator -reports:$(Carpenter.Output.Tests.Path)/coverage.cobertura.xml -targetdir:$(Carpenter.Output.TestCoverage.Path) "-reporttypes:Cobertura"
        displayName: Prepare code coverage
        condition: succeeded()
        continueOnError: true
    
      - task: PublishCodeCoverageResults@1
        displayName: 'Publish code coverage'
        condition: succeeded()
        continueOnError: true
        inputs:
          codeCoverageTool: Cobertura
          summaryFileLocation: '$(Carpenter.Output.TestCoverage.Path)/Cobertura.xml'

      - publish: '$(Carpenter.Output.Tests.Path)'
        displayName: 'Publish artifact: tests-L0'
        artifact: tests-L0
        condition: succeeded()
        continueOnError: true

    - ${{ if eq(parameters.sonarCloud, 'true') }}:
      - task: SonarSource.sonarcloud.ce096e50-6155-4de8-8800-4221aaeed4a1.SonarCloudAnalyze@1
        displayName: 'Analyze: SonarCloud'
        condition: succeeded()
    
      - task: SonarSource.sonarcloud.38b27399-a642-40af-bb7d-9971f69712e8.SonarCloudPublish@1
        displayName: 'Publish analysis: SonarCloud'
        condition: succeeded()
  
  - ${{ if and(ne(parameters.versionType, 'None'), eq(parameters.buildPurpose, 'Release'), eq(parameters.incrementVersionOnRelease, 'true')) }}:
    - task: PowerShell@2
      inputs:
        targetType: 'filePath'
        filePath: $(Carpenter.Pipeline.ScriptPath)/IncrementVersion.ps1
        arguments: -Verbose
      displayName: Update project version
      env:
        CARPENTER_PIPELINEBOT_TOKENSECRET: $(PipelineBot-GitHub-PAT)
